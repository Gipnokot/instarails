<div class="max-w-xl mx-auto p-4 pt-16">
  <div class="card bg-base-100 shadow-md border">

    <div class="flex items-center p-4 space-x-3 border-b">
      <% if @post.user.avatar_attacher&.stored? %>
        <%= image_tag @post.user.avatar_url(:thumb), class: "w-10 h-10 rounded-full object-cover" %>
      <% else %>
        <div class="w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center text-gray-600 font-semibold">
          <%= @post.user.email.first.upcase %>
        </div>
      <% end %>

      <div>
        <div class="font-semibold"><%= display_name(@post.user) %></div>
        <div class="text-sm text-gray-500">
          <%= @post.created_at.strftime("%B %d, %Y") %>
        </div>
      </div>
    </div>

    <% if @post.image_url(:show).present? %>
      <div class="border-b">
        <%= image_tag @post.image_url(:show), loading: "lazy",
                      class: "w-full object-cover aspect-square" %>
      </div>
    <% end %>

    <div class="px-4 py-3">
      <h1 class="text-xl font-bold mb-2"><%= @post.title %></h1>
      <div class="prose max-w-none text-gray-700">
        <%= simple_format(@post.body) %>
      </div>
    </div>

    <div class="flex flex-wrap gap-2 px-4 pb-4">
      <% if policy(@post).update? %>
        <%= link_to 'Edit', edit_post_path(@post), class: 'btn btn-outline btn-primary btn-sm' %>
      <% end %>
      <% if policy(@post).destroy? %>
        <%= button_to 'Delete', post_path(@post), method: :delete,
                      data: { turbo: false, confirm: 'Are you sure?' },
                      class: 'btn btn-outline btn-error btn-sm' %>
      <% end %>
      <%= link_to '← Back to Posts', posts_path, class: 'btn btn-secondary btn-sm' %>
    </div>
  </div>

  <% if @comment.errors.any? %>
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded my-4">
      <strong>Ошибки:</strong>
      <ul>
        <% @comment.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="mt-10">
    <h2 class="text-lg font-semibold mb-4">Comments</h2>

    <div class="space-y-4">
      <% @comments.each do |comment| %>
        <% cache(comment) do %>
          <div class="bg-base-100 p-4 rounded-lg shadow-sm border">
            <div class="flex justify-between items-center mb-2">
              <div class="text-sm text-gray-500">
                <strong><%= comment_author(comment) %></strong>
                <%= l(comment.created_at, format: :short) if comment.created_at.present? %>
              </div>
              <% if policy(comment).destroy? %>
                <%= button_to 'Удалить', post_comment_path(@post, comment), method: :delete,
                              data: { turbo: false, confirm: 'Are you sure?' },
                              class: "btn btn-xs btn-error btn-outline" %>
              <% end %>
            </div>
            <div class="text-gray-800">
              <%= simple_format(comment.body) %>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>

    <div class="mt-8">
      <h3 class="text-md font-medium mb-2">Add comment</h3>
      <%= render 'comments/form', post: @post, comment: @comment %>
    </div>
  </div>
</div>
